# Payload CMS Backend

This is the backend for the Qwik + Payload CMS website with Zitadel authentication and GraphQL API.

## Features

- **Payload CMS**: Headless CMS with intuitive admin panel
- **PostgreSQL Database**: Reliable data storage
- **GraphQL API**: Query products and variants
- **Zitadel Integration**: OAuth/OIDC authentication
- **User Management**: Integrated with Zitadel for user accounts

## Setup Instructions

### 1. Prerequisites

- Node.js 18+
- PostgreSQL database
- Zitadel instance (API endpoint and credentials)

### 2. Installation

```bash
cd payload-cms
npm install
```

### 3. Environment Configuration

Copy `.env.example` to `.env` and update with your values:

```bash
cp .env.example .env
```

**Required Variables:**
- `PAYLOAD_SECRET`: Secure key for Payload (min 32 characters)
- `DATABASE_URI`: PostgreSQL connection string
- `ZITADEL_API_URL`: Your Zitadel instance URL
- `ZITADEL_CLIENT_ID`: OAuth client ID from Zitadel
- `ZITADEL_CLIENT_SECRET`: OAuth client secret from Zitadel

### 4. Database Setup

Payload will automatically create tables on first run. For PostgreSQL, make sure the database exists:

```sql
CREATE DATABASE payload_db;
```

### 5. Running the Server

**Development:**
```bash
npm run dev
```

**Production Build:**
```bash
npm run build
npm start
```

The admin panel will be available at `http://localhost:3001/admin`

## GraphQL API

### Products Query

```graphql
query {
  Products {
    docs {
      id
      title
      description
      basePrice
      variants {
        sku
        name
        color
        size
        price
        stock
        isAvailable
      }
      featured
      category
    }
  }
}
```

### Single Product Query

```graphql
query {
  Products(where: { id: { equals: "PRODUCT_ID" } }) {
    docs {
      id
      title
      variants {
        sku
        name
        price
        stock
      }
    }
  }
}
```

## Zitadel Integration

### Authentication Flow

1. **Frontend** initiates login request to `/api/auth/zitadel-login`
2. **Backend** generates authorization URL and returns to frontend
3. **Frontend** redirects user to Zitadel login page
4. **Zitadel** redirects back to frontend with authorization code
5. **Frontend** sends code to `/api/auth/zitadel-callback`
6. **Backend** exchanges code for tokens and user info
7. **Backend** creates/updates user in Payload database

### OAuth Endpoints

- `GET /api/auth/zitadel-login` - Initiate login
- `POST /api/auth/zitadel-callback` - Handle OAuth callback
- `POST /api/auth/logout` - Logout user

## Collections

### Users
- Email (unique, indexed)
- Name
- Role (admin/user)
- Active status
- Zitadel ID (linked to Zitadel account)

### Products
- Title
- Description (rich text)
- Base Price
- Image
- Variants (array with SKU, name, color, size, price, stock)
- Category
- Tags
- Featured (for homepage)

## API Documentation

### GraphQL Endpoint
```
POST http://localhost:3001/graphql
```

### Rest API
Available REST endpoints will be generated by Payload automatically based on collections.

## Troubleshooting

### Database Connection Issues
- Verify PostgreSQL is running
- Check `DATABASE_URI` in `.env`
- Ensure database exists

### Zitadel Authentication Fails
- Verify `ZITADEL_API_URL` is correct and accessible
- Check `ZITADEL_CLIENT_ID` and `ZITADEL_CLIENT_SECRET`
- Ensure redirect URI is registered in Zitadel

### GraphQL Not Working
- Ensure `GRAPHQL_ENABLED=true` in `.env`
- Check Payload logs for errors
- Verify GraphQL plugin is installed

## Next Steps

1. Configure Zitadel with your credentials
2. Set up PostgreSQL database
3. Create initial admin user
4. Test GraphQL queries
5. Deploy to production

## Support

For issues with:
- **Payload CMS**: https://payloadcms.com/docs
- **Zitadel**: https://zitadel.com/docs
- **GraphQL**: https://graphql.org/learn/
